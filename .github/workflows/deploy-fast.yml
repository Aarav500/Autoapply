name: Fast Deploy (Build on Runner)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'

jobs:
  deploy:
    name: Build and Deploy (Fast Method)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Build Next.js application
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
        run: npm run build

      - name: Create deployment package
        run: |
          # Package only the built files and Dockerfile
          tar --exclude='.git' \
              --exclude='node_modules' \
              --exclude='src' \
              --exclude='*.md' \
              --exclude='.env*' \
              --warning=no-file-changed \
              -czf deploy-fast.tar.gz \
              .next \
              public \
              Dockerfile.fast \
              package.json \
              next.config.ts || [[ $? -eq 1 ]]

          ls -lh deploy-fast.tar.gz

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload to S3
        run: |
          aws s3 cp deploy-fast.tar.gz s3://${{ secrets.S3_BUCKET_NAME }}/deployments/autoapply-fast-${{ github.sha }}.tar.gz
          echo "Uploaded: s3://${{ secrets.S3_BUCKET_NAME }}/deployments/autoapply-fast-${{ github.sha }}.tar.gz"

      - name: Get EC2 instance IP
        id: get-ip
        run: |
          EC2_IP=$(aws ec2 describe-instances \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "ec2_ip=$EC2_IP" >> $GITHUB_OUTPUT
          echo "EC2 IP: $EC2_IP"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          COMMIT_SHA: ${{ github.sha }}
          S3_BUCKET: ${{ secrets.S3_BUCKET_NAME }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          APP_URL: ${{ secrets.NEXTAUTH_URL }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_PHONE_NUMBER: ${{ secrets.TWILIO_PHONE_NUMBER }}
          TWILIO_MESSAGING_SERVICE_SID: ${{ secrets.TWILIO_MESSAGING_SERVICE_SID }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          SENDGRID_FROM_EMAIL: ${{ secrets.SENDGRID_FROM_EMAIL }}
        with:
          host: ${{ steps.get-ip.outputs.ec2_ip }}
          username: ubuntu
          key: ${{ secrets.SECRET_KEY || secrets.EC2_SSH_PRIVATE_KEY }}
          envs: COMMIT_SHA,S3_BUCKET,AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_REGION,ANTHROPIC_API_KEY,APP_URL,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,TWILIO_ACCOUNT_SID,TWILIO_AUTH_TOKEN,TWILIO_PHONE_NUMBER,TWILIO_MESSAGING_SERVICE_SID,SENDGRID_API_KEY,SENDGRID_FROM_EMAIL
          script_stop: true
          command_timeout: 10m
          script: |
            set -e
            echo "=== Fast deployment starting ==="

            WORKDIR=/tmp/autoapply-fast-$COMMIT_SHA
            mkdir -p $WORKDIR
            cd $WORKDIR

            echo "=== Downloading pre-built package from S3 ==="
            aws s3 cp s3://$S3_BUCKET/deployments/autoapply-fast-$COMMIT_SHA.tar.gz . || {
              echo "‚ùå Failed to download from S3"
              exit 1
            }

            echo "=== Extracting package ==="
            tar -xzf autoapply-fast-$COMMIT_SHA.tar.gz || {
              echo "‚ùå Failed to extract package"
              exit 1
            }

            echo "=== Building minimal Docker image (should take <1 minute) ==="
            export DOCKER_BUILDKIT=1

            docker build \
              -f Dockerfile.fast \
              --progress=plain \
              -t autoapply:$COMMIT_SHA \
              -t autoapply:latest \
              . || {
              echo "‚ùå Docker build failed"
              exit 1
            }

            echo "‚úÖ Docker build successful"
            docker images | grep autoapply

            echo "=== Stopping old container ==="
            docker stop autoapply 2>/dev/null || echo "No running container"
            docker rm autoapply 2>/dev/null || echo "No container to remove"

            echo "=== Starting new container ==="
            docker run -d \
              --name autoapply \
              --restart unless-stopped \
              -p 80:3000 \
              -e NODE_ENV=production \
              -e AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID" \
              -e AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY" \
              -e AWS_REGION="$AWS_REGION" \
              -e S3_BUCKET_NAME="$S3_BUCKET" \
              -e ANTHROPIC_API_KEY="$ANTHROPIC_API_KEY" \
              -e APP_URL="$APP_URL" \
              -e JWT_ACCESS_SECRET="$(openssl rand -hex 32)" \
              -e JWT_REFRESH_SECRET="$(openssl rand -hex 32)" \
              -e ENCRYPTION_KEY="$(openssl rand -hex 32)" \
              -e GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID" \
              -e GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET" \
              -e GOOGLE_REDIRECT_URI="$APP_URL/api/auth/oauth/google/callback" \
              -e TWILIO_ACCOUNT_SID="$TWILIO_ACCOUNT_SID" \
              -e TWILIO_AUTH_TOKEN="$TWILIO_AUTH_TOKEN" \
              -e TWILIO_PHONE_NUMBER="$TWILIO_PHONE_NUMBER" \
              -e TWILIO_MESSAGING_SERVICE_SID="$TWILIO_MESSAGING_SERVICE_SID" \
              -e SENDGRID_API_KEY="$SENDGRID_API_KEY" \
              -e SENDGRID_FROM_EMAIL="$SENDGRID_FROM_EMAIL" \
              autoapply:latest || {
                echo "‚ùå Failed to start container"
                exit 1
              }

            echo "‚úÖ Container started"
            docker ps | grep autoapply

            echo "=== Waiting for app to initialize ==="
            sleep 10

            echo "=== Testing health endpoint ==="
            for i in {1..10}; do
              if curl -f http://localhost:3000/api/health 2>/dev/null; then
                echo "‚úÖ Health check passed"
                break
              fi
              echo "Attempt $i/10 failed, waiting..."
              sleep 3
            done

            echo "=== Container logs (last 30 lines) ==="
            docker logs autoapply --tail 30

            echo "=== Cleaning up ==="
            docker image prune -f
            cd /tmp
            rm -rf $WORKDIR

            echo "=== Fast deployment complete ==="

      - name: Health check
        run: |
          echo "Waiting for application to fully start..."
          sleep 15

          MAX_ATTEMPTS=10
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            echo "Health check attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS..."
            if curl -f http://${{ steps.get-ip.outputs.ec2_ip }}/api/health 2>/dev/null; then
              echo "‚úÖ External health check passed!"
              exit 0
            fi

            ATTEMPT=$((ATTEMPT + 1))
            sleep 5
          done

          echo "‚ö†Ô∏è External health check failed after $MAX_ATTEMPTS attempts"
          exit 1

      - name: Deployment summary
        if: success()
        run: |
          echo "üéâ Fast deployment complete!"
          echo ""
          echo "üìä Details:"
          echo "  Method: Pre-built on GitHub Runner"
          echo "  URL: ${{ secrets.NEXTAUTH_URL }}"
          echo "  IP: ${{ steps.get-ip.outputs.ec2_ip }}"
          echo "  Health: http://${{ steps.get-ip.outputs.ec2_ip }}/api/health"
          echo "  Commit: ${{ github.sha }}"
          echo ""
          echo "‚ö° Build time saved by building on runner instead of EC2"
