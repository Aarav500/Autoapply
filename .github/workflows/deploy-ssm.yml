name: Deploy via SSM (No SSH Key Required)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to EC2 via AWS SSM
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Build Next.js application
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
        run: npm run build

      - name: Create deployment package
        run: |
          tar --exclude='.git' \
              --exclude='node_modules' \
              --exclude='src' \
              --exclude='*.md' \
              --exclude='.env*' \
              --warning=no-file-changed \
              -czf deploy.tar.gz \
              .next \
              public \
              Dockerfile.fast \
              package.json \
              next.config.ts || [[ $? -eq 1 ]]

          ls -lh deploy.tar.gz
          echo "Package size: $(du -h deploy.tar.gz | cut -f1)"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload to S3
        run: |
          aws s3 cp deploy.tar.gz s3://${{ secrets.S3_BUCKET_NAME }}/deployments/autoapply-${{ github.sha }}.tar.gz
          echo "âœ… Uploaded to S3"

      - name: Create deployment script
        id: create-script
        env:
          COMMIT_SHA: ${{ github.sha }}
          S3_BUCKET: ${{ secrets.S3_BUCKET_NAME }}
          AWS_KEY: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          CLAUDE_KEY: ${{ secrets.CLAUDE_API_KEY }}
          APP_URL: ${{ secrets.NEXTAUTH_URL }}
          GOOGLE_CID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          TWILIO_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_PHONE: ${{ secrets.TWILIO_PHONE_NUMBER }}
          TWILIO_MSG_SID: ${{ secrets.TWILIO_MESSAGING_SERVICE_SID }}
          SENDGRID_KEY: ${{ secrets.SENDGRID_API_KEY }}
          SENDGRID_EMAIL: ${{ secrets.SENDGRID_FROM_EMAIL }}
        run: |
          # Create deployment script file
          cat > /tmp/deploy.sh << 'SCRIPT_END'
          #!/bin/bash
          set -e

          echo "=== AutoApply Deployment Started ==="
          echo "Commit: ${COMMIT_SHA}"
          echo "Time: $(date)"

          WORKDIR=/tmp/autoapply-deploy-${COMMIT_SHA}
          mkdir -p $WORKDIR && cd $WORKDIR

          echo "=== Downloading from S3 ==="
          aws s3 cp s3://${S3_BUCKET}/deployments/autoapply-${COMMIT_SHA}.tar.gz . || exit 1

          echo "=== Extracting ==="
          tar -xzf autoapply-${COMMIT_SHA}.tar.gz || exit 1

          echo "=== Building Docker image ==="
          export DOCKER_BUILDKIT=1
          docker build -f Dockerfile.fast -t autoapply:latest . || exit 1

          echo "=== Stopping old container ==="
          docker stop autoapply 2>/dev/null || true
          docker rm autoapply 2>/dev/null || true

          echo "=== Starting container ==="
          docker run -d --name autoapply --restart unless-stopped -p 80:3000 \
            -e NODE_ENV=production \
            -e AWS_ACCESS_KEY_ID="${AWS_KEY}" \
            -e AWS_SECRET_ACCESS_KEY="${AWS_SECRET}" \
            -e AWS_REGION="${AWS_REGION}" \
            -e S3_BUCKET_NAME="${S3_BUCKET}" \
            -e ANTHROPIC_API_KEY="${CLAUDE_KEY}" \
            -e APP_URL="${APP_URL}" \
            -e JWT_ACCESS_SECRET="$(openssl rand -hex 32)" \
            -e JWT_REFRESH_SECRET="$(openssl rand -hex 32)" \
            -e ENCRYPTION_KEY="$(openssl rand -hex 32)" \
            -e GOOGLE_CLIENT_ID="${GOOGLE_CID}" \
            -e GOOGLE_CLIENT_SECRET="${GOOGLE_SECRET}" \
            -e GOOGLE_REDIRECT_URI="${APP_URL}/api/auth/oauth/google/callback" \
            -e TWILIO_ACCOUNT_SID="${TWILIO_SID}" \
            -e TWILIO_AUTH_TOKEN="${TWILIO_TOKEN}" \
            -e TWILIO_PHONE_NUMBER="${TWILIO_PHONE}" \
            -e TWILIO_MESSAGING_SERVICE_SID="${TWILIO_MSG_SID}" \
            -e SENDGRID_API_KEY="${SENDGRID_KEY}" \
            -e SENDGRID_FROM_EMAIL="${SENDGRID_EMAIL}" \
            autoapply:latest || exit 1

          echo "=== Health check ==="
          sleep 15
          for i in {1..20}; do
            if curl -sf http://localhost:3000/api/health >/dev/null 2>&1; then
              echo "âœ… Health check passed"
              curl -s http://localhost:3000/api/health
              break
            fi
            echo "Attempt $i/20..."
            sleep 3
          done

          echo "=== Container logs ==="
          docker logs autoapply --tail 30

          echo "=== Cleanup ==="
          docker image prune -f
          cd /tmp && rm -rf $WORKDIR

          echo "=== Deployment Complete ==="
          SCRIPT_END

          # Replace placeholders in script
          sed -i "s/\${COMMIT_SHA}/$COMMIT_SHA/g" /tmp/deploy.sh
          sed -i "s|\${S3_BUCKET}|$S3_BUCKET|g" /tmp/deploy.sh
          sed -i "s|\${AWS_KEY}|$AWS_KEY|g" /tmp/deploy.sh
          sed -i "s|\${AWS_SECRET}|$AWS_SECRET|g" /tmp/deploy.sh
          sed -i "s|\${AWS_REGION}|$AWS_REGION|g" /tmp/deploy.sh
          sed -i "s|\${CLAUDE_KEY}|$CLAUDE_KEY|g" /tmp/deploy.sh
          sed -i "s|\${APP_URL}|$APP_URL|g" /tmp/deploy.sh
          sed -i "s|\${GOOGLE_CID}|$GOOGLE_CID|g" /tmp/deploy.sh
          sed -i "s|\${GOOGLE_SECRET}|$GOOGLE_SECRET|g" /tmp/deploy.sh
          sed -i "s|\${TWILIO_SID}|$TWILIO_SID|g" /tmp/deploy.sh
          sed -i "s|\${TWILIO_TOKEN}|$TWILIO_TOKEN|g" /tmp/deploy.sh
          sed -i "s|\${TWILIO_PHONE}|$TWILIO_PHONE|g" /tmp/deploy.sh
          sed -i "s|\${TWILIO_MSG_SID}|$TWILIO_MSG_SID|g" /tmp/deploy.sh
          sed -i "s|\${SENDGRID_KEY}|$SENDGRID_KEY|g" /tmp/deploy.sh
          sed -i "s|\${SENDGRID_EMAIL}|$SENDGRID_EMAIL|g" /tmp/deploy.sh

          # Upload script to S3
          aws s3 cp /tmp/deploy.sh s3://$S3_BUCKET/deployments/deploy-script-${{ github.sha }}.sh
          echo "âœ… Script uploaded to S3"

      - name: Deploy via SSM
        id: deploy
        run: |
          echo "Starting SSM deployment..."

          # Download and execute script via SSM
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --timeout-seconds 3600 \
            --comment "AutoApply deployment - commit ${{ github.sha }}" \
            --parameters 'commands=["aws s3 cp s3://${{ secrets.S3_BUCKET_NAME }}/deployments/deploy-script-${{ github.sha }}.sh /tmp/deploy.sh && chmod +x /tmp/deploy.sh && /tmp/deploy.sh"]' \
            --output text \
            --query 'Command.CommandId')

          echo "SSM Command ID: $COMMAND_ID"
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "â³ Waiting for deployment to complete (10-15 minutes)..."

      - name: Monitor SSM Command
        run: |
          COMMAND_ID="${{ steps.deploy.outputs.command_id }}"
          MAX_WAIT=3600
          ELAPSED=0

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id $COMMAND_ID \
              --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")

            echo "[$ELAPSED s] Status: $STATUS"

            if [ "$STATUS" = "Success" ]; then
              echo "âœ… Command completed successfully"
              break
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo "âŒ Command failed with status: $STATUS"
              break
            fi

            sleep 15
            ELAPSED=$((ELAPSED + 15))
          done

          echo ""
          echo "=== DEPLOYMENT OUTPUT ==="
          aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'StandardOutputContent' \
            --output text

          echo ""
          echo "=== ERRORS (if any) ==="
          aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'StandardErrorContent' \
            --output text || echo "No errors"

          FINAL_STATUS=$(aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'Status' \
            --output text)

          if [ "$FINAL_STATUS" != "Success" ]; then
            echo "âŒ Deployment failed with status: $FINAL_STATUS"
            exit 1
          fi

      - name: Get EC2 IP for health check
        id: get-ip
        run: |
          EC2_IP=$(aws ec2 describe-instances \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "ec2_ip=$EC2_IP" >> $GITHUB_OUTPUT
          echo "EC2 Public IP: $EC2_IP"

      - name: External health check
        run: |
          echo "Testing external access..."
          sleep 10

          for i in {1..10}; do
            echo "Health check attempt $i/10..."
            if curl -sf http://${{ steps.get-ip.outputs.ec2_ip }}/api/health; then
              echo ""
              echo "âœ… External health check passed!"
              exit 0
            fi
            sleep 5
          done

          echo "âš ï¸ External health check failed"
          echo "Container may be running but not accessible from internet"
          echo "Check security groups allow port 80"

      - name: Deployment summary
        if: success()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     Deployment Successful! ğŸ‰         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Details:"
          echo "  Method: SSM (No SSH key required)"
          echo "  URL: ${{ secrets.NEXTAUTH_URL }}"
          echo "  IP: ${{ steps.get-ip.outputs.ec2_ip }}"
          echo "  Health: http://${{ steps.get-ip.outputs.ec2_ip }}/api/health"
          echo "  Commit: ${{ github.sha }}"
          echo ""
          echo "ğŸ”— Access your application:"
          echo "  http://${{ steps.get-ip.outputs.ec2_ip }}"
          echo ""
