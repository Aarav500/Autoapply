name: Deploy via SSM (No SSH Key Required)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to EC2 via AWS SSM
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Build Next.js application
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
        run: npm run build

      - name: Create deployment package
        run: |
          tar --exclude='.git' \
              --exclude='node_modules' \
              --exclude='src' \
              --exclude='*.md' \
              --exclude='.env*' \
              --warning=no-file-changed \
              -czf deploy.tar.gz \
              .next \
              public \
              Dockerfile.fast \
              package.json \
              next.config.ts || [[ $? -eq 1 ]]

          ls -lh deploy.tar.gz
          echo "Package size: $(du -h deploy.tar.gz | cut -f1)"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload to S3
        run: |
          aws s3 cp deploy.tar.gz s3://${{ secrets.S3_BUCKET_NAME }}/deployments/autoapply-${{ github.sha }}.tar.gz
          echo "âœ… Uploaded to S3"

      - name: Deploy via SSM
        id: deploy
        run: |
          echo "Starting SSM deployment..."

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --timeout-seconds 3600 \
            --comment "AutoApply deployment - commit ${{ github.sha }}" \
            --parameters '{
              "commands": [
                "set -e",
                "echo \"=== AutoApply Deployment Started ===\"",
                "echo \"Commit: ${{ github.sha }}\"",
                "echo \"Time: $(date)\"",
                "",
                "WORKDIR=/tmp/autoapply-deploy-${{ github.sha }}",
                "mkdir -p $WORKDIR",
                "cd $WORKDIR",
                "",
                "echo \"=== Downloading from S3 ===\"",
                "aws s3 cp s3://${{ secrets.S3_BUCKET_NAME }}/deployments/autoapply-${{ github.sha }}.tar.gz . || {",
                "  echo \"âŒ S3 download failed\"",
                "  exit 1",
                "}",
                "",
                "echo \"=== Extracting package ===\"",
                "tar -xzf autoapply-${{ github.sha }}.tar.gz || {",
                "  echo \"âŒ Extraction failed\"",
                "  exit 1",
                "}",
                "",
                "echo \"=== Building Docker image ===\"",
                "export DOCKER_BUILDKIT=1",
                "docker build -f Dockerfile.fast --progress=plain -t autoapply:${{ github.sha }} -t autoapply:latest . || {",
                "  echo \"âŒ Docker build failed\"",
                "  exit 1",
                "}",
                "",
                "echo \"âœ… Docker image built\"",
                "docker images | grep autoapply | head -2",
                "",
                "echo \"=== Stopping old container ===\"",
                "docker stop autoapply 2>/dev/null || echo \"No container to stop\"",
                "docker rm autoapply 2>/dev/null || echo \"No container to remove\"",
                "",
                "echo \"=== Starting new container ===\"",
                "docker run -d \\",
                "  --name autoapply \\",
                "  --restart unless-stopped \\",
                "  -p 80:3000 \\",
                "  -e NODE_ENV=production \\",
                "  -e AWS_ACCESS_KEY_ID=\"${{ secrets.AWS_ACCESS_KEY_ID }}\" \\",
                "  -e AWS_SECRET_ACCESS_KEY=\"${{ secrets.AWS_SECRET_ACCESS_KEY }}\" \\",
                "  -e AWS_REGION=\"${{ secrets.AWS_REGION }}\" \\",
                "  -e S3_BUCKET_NAME=\"${{ secrets.S3_BUCKET_NAME }}\" \\",
                "  -e ANTHROPIC_API_KEY=\"${{ secrets.CLAUDE_API_KEY }}\" \\",
                "  -e APP_URL=\"${{ secrets.NEXTAUTH_URL }}\" \\",
                "  -e JWT_ACCESS_SECRET=\"$(openssl rand -hex 32)\" \\",
                "  -e JWT_REFRESH_SECRET=\"$(openssl rand -hex 32)\" \\",
                "  -e ENCRYPTION_KEY=\"$(openssl rand -hex 32)\" \\",
                "  -e GOOGLE_CLIENT_ID=\"${{ secrets.GOOGLE_CLIENT_ID }}\" \\",
                "  -e GOOGLE_CLIENT_SECRET=\"${{ secrets.GOOGLE_CLIENT_SECRET }}\" \\",
                "  -e GOOGLE_REDIRECT_URI=\"${{ secrets.NEXTAUTH_URL }}/api/auth/oauth/google/callback\" \\",
                "  -e TWILIO_ACCOUNT_SID=\"${{ secrets.TWILIO_ACCOUNT_SID }}\" \\",
                "  -e TWILIO_AUTH_TOKEN=\"${{ secrets.TWILIO_AUTH_TOKEN }}\" \\",
                "  -e TWILIO_PHONE_NUMBER=\"${{ secrets.TWILIO_PHONE_NUMBER }}\" \\",
                "  -e TWILIO_MESSAGING_SERVICE_SID=\"${{ secrets.TWILIO_MESSAGING_SERVICE_SID }}\" \\",
                "  -e SENDGRID_API_KEY=\"${{ secrets.SENDGRID_API_KEY }}\" \\",
                "  -e SENDGRID_FROM_EMAIL=\"${{ secrets.SENDGRID_FROM_EMAIL }}\" \\",
                "  autoapply:latest || {",
                "    echo \"âŒ Container start failed\"",
                "    exit 1",
                "  }",
                "",
                "echo \"âœ… Container started\"",
                "docker ps | grep autoapply",
                "",
                "echo \"=== Waiting for application ===\"",
                "sleep 15",
                "",
                "echo \"=== Health check ===\"",
                "for i in {1..20}; do",
                "  if curl -sf http://localhost:3000/api/health >/dev/null 2>&1; then",
                "    echo \"âœ… Health check passed\"",
                "    curl -s http://localhost:3000/api/health | head -5",
                "    break",
                "  fi",
                "  echo \"Attempt $i/20...\"",
                "  sleep 3",
                "done",
                "",
                "echo \"=== Container logs ===\"",
                "docker logs autoapply --tail 30",
                "",
                "echo \"=== Cleanup ===\"",
                "docker image prune -f",
                "cd /tmp",
                "rm -rf $WORKDIR",
                "",
                "echo \"=== Deployment Complete ===\"",
                "echo \"Commit: ${{ github.sha }}\"",
                "echo \"Time: $(date)\""
              ]
            }' \
            --output text \
            --query 'Command.CommandId')

          echo "SSM Command ID: $COMMAND_ID"
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT

          echo "â³ Waiting for deployment to complete..."
          echo "This may take 10-15 minutes for the build..."

      - name: Monitor SSM Command
        run: |
          COMMAND_ID="${{ steps.deploy.outputs.command_id }}"
          MAX_WAIT=3600
          ELAPSED=0

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id $COMMAND_ID \
              --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")

            echo "[$ELAPSED s] Status: $STATUS"

            if [ "$STATUS" = "Success" ]; then
              echo "âœ… Command completed successfully"
              break
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo "âŒ Command failed with status: $STATUS"
              break
            fi

            sleep 15
            ELAPSED=$((ELAPSED + 15))
          done

          echo ""
          echo "=== DEPLOYMENT OUTPUT ==="
          aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'StandardOutputContent' \
            --output text

          echo ""
          echo "=== ERRORS (if any) ==="
          aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'StandardErrorContent' \
            --output text || echo "No errors"

          FINAL_STATUS=$(aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'Status' \
            --output text)

          if [ "$FINAL_STATUS" != "Success" ]; then
            echo "âŒ Deployment failed with status: $FINAL_STATUS"
            exit 1
          fi

      - name: Get EC2 IP for health check
        id: get-ip
        run: |
          EC2_IP=$(aws ec2 describe-instances \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "ec2_ip=$EC2_IP" >> $GITHUB_OUTPUT
          echo "EC2 Public IP: $EC2_IP"

      - name: External health check
        run: |
          echo "Testing external access..."
          sleep 10

          for i in {1..10}; do
            echo "Health check attempt $i/10..."
            if curl -sf http://${{ steps.get-ip.outputs.ec2_ip }}/api/health; then
              echo ""
              echo "âœ… External health check passed!"
              exit 0
            fi
            sleep 5
          done

          echo "âš ï¸ External health check failed"
          echo "Container may be running but not accessible from internet"
          echo "Check security groups allow port 80"

      - name: Deployment summary
        if: success()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     Deployment Successful! ğŸ‰         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Details:"
          echo "  Method: SSM (No SSH key required)"
          echo "  URL: ${{ secrets.NEXTAUTH_URL }}"
          echo "  IP: ${{ steps.get-ip.outputs.ec2_ip }}"
          echo "  Health: http://${{ steps.get-ip.outputs.ec2_ip }}/api/health"
          echo "  Commit: ${{ github.sha }}"
          echo ""
          echo "ğŸ”— Access your application:"
          echo "  http://${{ steps.get-ip.outputs.ec2_ip }}"
          echo ""
