name: Debug Deployment

on:
  workflow_dispatch:

jobs:
  debug:
    name: Debug EC2 Deployment
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get EC2 instance IP
        id: get-ip
        run: |
          EC2_IP=$(aws ec2 describe-instances \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "ec2_ip=$EC2_IP" >> $GITHUB_OUTPUT
          echo "EC2 IP: $EC2_IP"

      - name: Check Docker status
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "echo === Docker Version ===",
              "docker --version",
              "echo",
              "echo === Docker Containers ===",
              "docker ps -a",
              "echo",
              "echo === Docker Images ===",
              "docker images | head -10",
              "echo",
              "echo === Autoapply Container Logs (last 100 lines) ===",
              "docker logs autoapply --tail 100 2>&1 || echo No container named autoapply",
              "echo",
              "echo === Autoapply Container Inspect ===",
              "docker inspect autoapply 2>&1 || echo No container named autoapply",
              "echo",
              "echo === Network Test ===",
              "curl -v http://localhost:3000/api/health 2>&1 || echo Could not connect to localhost:3000",
              "echo",
              "echo === Disk Space ===",
              "df -h",
              "echo",
              "echo === Memory ===",
              "free -h"
            ]' \
            --output text \
            --query 'Command.CommandId')

          echo "Command ID: $COMMAND_ID"
          echo "Waiting for results..."
          sleep 15

          echo "=== FULL OUTPUT ==="
          aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --output text

      - name: Test external connectivity
        run: |
          echo "Testing connection from GitHub Actions runner to EC2..."
          curl -v http://${{ steps.get-ip.outputs.ec2_ip }}:80/api/health 2>&1 || echo "Cannot reach EC2 from internet"

          echo ""
          echo "Testing port 3000 directly..."
          curl -v http://${{ steps.get-ip.outputs.ec2_ip }}:3000/api/health 2>&1 || echo "Cannot reach port 3000"
