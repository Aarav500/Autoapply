name: Diagnose EC2 Setup

on:
  workflow_dispatch:

jobs:
  diagnose:
    name: Check EC2 and SSM Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Check EC2 instance exists
        run: |
          echo "Checking EC2 instance: ${{ secrets.EC2_INSTANCE_ID }}"
          aws ec2 describe-instances \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].[InstanceId,State.Name,InstanceType,PublicIpAddress,PrivateIpAddress]' \
            --output table || echo "Instance not found or no access"

      - name: Check SSM agent status
        run: |
          echo "Checking SSM agent connectivity..."
          aws ssm describe-instance-information \
            --filters "Key=InstanceIds,Values=${{ secrets.EC2_INSTANCE_ID }}" \
            --query 'InstanceInformationList[0].[InstanceId,PingStatus,PlatformType,PlatformName,PlatformVersion,AgentVersion]' \
            --output table || echo "SSM agent not responding"

      - name: Check IAM instance profile
        run: |
          echo "Checking IAM instance profile..."
          aws ec2 describe-instances \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].IamInstanceProfile' \
            --output json || echo "No IAM instance profile attached"

      - name: Test simple SSM command
        run: |
          echo "Testing simple SSM command (whoami)..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --timeout-seconds 60 \
            --parameters 'commands=["whoami","pwd","echo $HOME","docker --version"]' \
            --output text \
            --query 'Command.CommandId')

          echo "Command ID: $COMMAND_ID"
          echo "Waiting for command..."
          sleep 10

          echo "=== Command Output ==="
          aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --query '[Status,StandardOutputContent,StandardErrorContent]' \
            --output text

      - name: Check S3 bucket access
        run: |
          echo "Checking S3 bucket: ${{ secrets.S3_BUCKET_NAME }}"
          aws s3 ls s3://${{ secrets.S3_BUCKET_NAME }}/ || echo "Cannot access S3 bucket"

      - name: Summary
        run: |
          echo "=== Diagnostic Summary ==="
          echo "If SSM agent is not responding, you need to:"
          echo "1. Install SSM agent on EC2 instance"
          echo "2. Attach IAM role with SSM permissions (AmazonSSMManagedInstanceCore)"
          echo "3. Ensure instance has internet access or VPC endpoints for SSM"
          echo ""
          echo "If Docker is not installed:"
          echo "1. SSH into instance and run: sudo yum install -y docker"
          echo "2. Start Docker: sudo systemctl start docker"
          echo "3. Enable Docker: sudo systemctl enable docker"
