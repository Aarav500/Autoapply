name: Manual Deploy (No SSH Required)

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    name: Deploy via SSM Run Command
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js application
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
        run: npm run build

      - name: Create deployment package
        run: |
          mkdir -p deploy

          # Copy standalone output
          cp -r .next/standalone/* deploy/

          # Copy static files (create .next directory structure first)
          mkdir -p deploy/.next
          cp -r .next/static deploy/.next/static

          # Copy public files
          cp -r public deploy/public

          # Copy Dockerfile
          cp Dockerfile.fast deploy/Dockerfile

          # Copy docker-compose.yml if it exists
          cp docker-compose.yml deploy/ || true

          # Create .env file
          cat > deploy/.env << EOF
          NODE_ENV=production
          AWS_REGION=${{ env.AWS_REGION }}
          AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_PHONE_NUMBER=${{ secrets.TWILIO_PHONE_NUMBER }}
          TWILIO_WHATSAPP_NUMBER=${{ secrets.TWILIO_WHATSAPP_NUMBER }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
          NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }}
          EOF

          tar -czf deploy.tar.gz -C deploy .

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload to S3
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          S3_PATH="s3://${{ secrets.S3_BUCKET_NAME }}/deployments/${TIMESTAMP}/deploy.tar.gz"
          aws s3 cp deploy.tar.gz "$S3_PATH"
          echo "S3_PATH=$S3_PATH" >> $GITHUB_ENV
          echo "Uploaded to: $S3_PATH"

      - name: Check SSM Agent status
        id: check-ssm
        continue-on-error: true
        run: |
          echo "Checking if SSM Agent is available..."

          INSTANCE_INFO=$(aws ssm describe-instance-information \
            --filters "Key=InstanceIds,Values=${{ secrets.EC2_INSTANCE_ID }}" \
            --query "InstanceInformationList[0]" \
            --output json 2>&1)

          if echo "$INSTANCE_INFO" | grep -q "PingStatus"; then
            PING_STATUS=$(echo "$INSTANCE_INFO" | jq -r '.PingStatus')
            echo "SSM Agent Status: $PING_STATUS"

            if [ "$PING_STATUS" = "Online" ]; then
              echo "ssm_available=true" >> $GITHUB_OUTPUT
              echo "âœ… SSM Agent is online"
            else
              echo "ssm_available=false" >> $GITHUB_OUTPUT
              echo "âš ï¸ SSM Agent is $PING_STATUS"
            fi
          else
            echo "ssm_available=false" >> $GITHUB_OUTPUT
            echo "âŒ SSM Agent not found"
          fi

      - name: Deploy via SSM
        if: steps.check-ssm.outputs.ssm_available == 'true'
        run: |
          echo "ðŸš€ Starting deployment via SSM..."

          # Create deployment script
          cat > /tmp/deploy-script.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e

          echo "=== Starting deployment ==="

          # Stop existing containers
          echo "Stopping existing containers..."
          docker stop autoapply-app 2>/dev/null || true
          docker rm autoapply-app 2>/dev/null || true

          # Download from S3
          echo "Downloading deployment package..."
          mkdir -p /home/ubuntu/autoapply
          cd /home/ubuntu/autoapply
          aws s3 cp "$S3_PATH" deploy.tar.gz

          # Extract
          echo "Extracting package..."
          rm -rf app
          mkdir -p app
          tar -xzf deploy.tar.gz -C app
          cd app

          # Build Docker image
          echo "Building Docker image..."
          docker build -f Dockerfile -t autoapply:latest .

          # Run container
          echo "Starting container..."
          docker run -d \
            --name autoapply-app \
            --restart unless-stopped \
            -p 3000:3000 \
            --env-file .env \
            autoapply:latest

          # Wait for health check
          echo "Waiting for application to start..."
          for i in {1..30}; do
            if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "âœ… Application is healthy"
              docker logs autoapply-app --tail 20
              exit 0
            fi
            echo "Attempt $i/30: waiting..."
            sleep 2
          done

          echo "âŒ Application failed to start"
          docker logs autoapply-app
          exit 1
          DEPLOY_SCRIPT

          # Send command
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "AutoApply deployment" \
            --timeout-seconds 1800 \
            --parameters "{\"commands\":[\"export S3_PATH='${{ env.S3_PATH }}'\",\"$(cat /tmp/deploy-script.sh | sed 's/"/\\"/g')\"]}" \
            --query "Command.CommandId" \
            --output text)

          echo "SSM Command ID: $COMMAND_ID"
          echo "Waiting for deployment to complete..."

          # Wait for completion
          for i in {1..120}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
              --query "Status" \
              --output text 2>/dev/null || echo "Pending")

            echo "[$((i * 5))s] Status: $STATUS"

            if [ "$STATUS" = "Success" ]; then
              echo "âœ… Deployment succeeded!"
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
                --query "StandardOutputContent" \
                --output text
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo "âŒ Deployment failed with status: $STATUS"
              echo ""
              echo "=== STDOUT ==="
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
                --query "StandardOutputContent" \
                --output text || echo "(empty)"
              echo ""
              echo "=== STDERR ==="
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
                --query "StandardErrorContent" \
                --output text || echo "(empty)"
              exit 1
            fi

            sleep 5
          done

          echo "âŒ Timeout waiting for deployment"
          exit 1

      - name: Install SSM Agent (if not available)
        if: steps.check-ssm.outputs.ssm_available != 'true'
        run: |
          echo "âŒ SSM Agent is not available on EC2 instance"
          echo ""
          echo "To enable SSM-based deployment:"
          echo "1. Connect to your EC2 instance (use EC2 Instance Connect or SSH if working)"
          echo "2. Install SSM Agent:"
          echo "   sudo snap install amazon-ssm-agent --classic"
          echo "   sudo snap start amazon-ssm-agent"
          echo "3. Verify IAM role has AmazonSSMManagedInstanceCore policy"
          echo ""
          echo "Alternatively, fix SSH connectivity and use the main deploy.yml workflow"
          exit 1

      - name: Deployment summary
        if: success()
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployment successful via SSM**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Instance**: ${{ secrets.EC2_INSTANCE_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Package**: ${{ env.S3_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Method**: AWS Systems Manager Run Command" >> $GITHUB_STEP_SUMMARY
