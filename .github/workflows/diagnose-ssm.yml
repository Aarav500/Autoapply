name: Diagnose EC2 SSM Setup

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  diagnose:
    name: Check SSM Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check EC2 Instance
        run: |
          echo "=== EC2 Instance Information ==="
          aws ec2 describe-instances \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].[InstanceId,State.Name,PublicIpAddress,IamInstanceProfile.Arn,Platform]' \
            --output table

      - name: Check IAM Instance Profile
        run: |
          echo ""
          echo "=== IAM Instance Profile ==="

          PROFILE_ARN=$(aws ec2 describe-instances \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].IamInstanceProfile.Arn' \
            --output text)

          if [ "$PROFILE_ARN" = "None" ] || [ -z "$PROFILE_ARN" ]; then
            echo "❌ NO IAM Instance Profile attached!"
            echo ""
            echo "REQUIRED ACTION:"
            echo "1. Create an IAM role with 'AmazonSSMManagedInstanceCore' policy"
            echo "2. Attach it to your EC2 instance"
            echo ""
            echo "Quick fix:"
            echo "  - Go to EC2 Console → Select instance → Actions → Security → Modify IAM role"
            echo "  - Select a role that has SSM permissions"
            exit 1
          else
            echo "✅ Instance Profile: $PROFILE_ARN"

            # Get role name from profile ARN
            ROLE_NAME=$(echo $PROFILE_ARN | sed 's/.*instance-profile\///' | sed 's/\/.*//')

            echo ""
            echo "=== IAM Role Policies ==="
            aws iam list-attached-role-policies \
              --role-name $ROLE_NAME \
              --query 'AttachedPolicies[*].[PolicyName,PolicyArn]' \
              --output table

            # Check if has SSM policy
            HAS_SSM=$(aws iam list-attached-role-policies \
              --role-name $ROLE_NAME \
              --query 'AttachedPolicies[?contains(PolicyName, `SSM`) || contains(PolicyArn, `SSM`)].PolicyName' \
              --output text)

            if [ -z "$HAS_SSM" ]; then
              echo ""
              echo "⚠️  WARNING: No SSM policy found!"
              echo "Attach 'AmazonSSMManagedInstanceCore' to role: $ROLE_NAME"
            else
              echo ""
              echo "✅ SSM policy found"
            fi
          fi

      - name: Check SSM Agent Status
        run: |
          echo ""
          echo "=== SSM Agent Status ==="

          SSM_INFO=$(aws ssm describe-instance-information \
            --filters "Key=InstanceIds,Values=${{ secrets.EC2_INSTANCE_ID }}" \
            --query 'InstanceInformationList[0]' \
            --output json 2>&1)

          if echo "$SSM_INFO" | grep -q "PingStatus"; then
            echo "$SSM_INFO" | jq -r '"Instance ID: " + .InstanceId'
            echo "$SSM_INFO" | jq -r '"Ping Status: " + .PingStatus'
            echo "$SSM_INFO" | jq -r '"Agent Version: " + .AgentVersion'
            echo "$SSM_INFO" | jq -r '"Platform: " + .PlatformType + " " + .PlatformName + " " + .PlatformVersion'
            echo "$SSM_INFO" | jq -r '"Last Ping: " + .LastPingDateTime'

            PING_STATUS=$(echo "$SSM_INFO" | jq -r '.PingStatus')

            if [ "$PING_STATUS" = "Online" ]; then
              echo ""
              echo "✅ SSM Agent is ONLINE and ready!"
              echo "Deployment should work now."
            else
              echo ""
              echo "⚠️  SSM Agent status: $PING_STATUS"
              echo "Wait a few minutes and try again."
            fi
          else
            echo "❌ SSM Agent NOT registered with AWS Systems Manager"
            echo ""

            # Get OS info
            PLATFORM=$(aws ec2 describe-instances \
              --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
              --query 'Reservations[0].Instances[0].PlatformDetails' \
              --output text)

            echo "Platform: $PLATFORM"
            echo ""
            echo "=========================================="
            echo "DIAGNOSIS: SSM Agent Issue"
            echo "=========================================="
            echo ""
            echo "Possible causes:"
            echo "1. SSM Agent not installed"
            echo "2. SSM Agent installed but not running"
            echo "3. SSM Agent needs time to register (wait 2-3 min)"
            echo ""
            echo "=========================================="
            echo "FIX: Connect and Install SSM Agent"
            echo "=========================================="
            echo ""
            echo "Step 1: Connect to EC2 via Instance Connect"
            echo "   https://console.aws.amazon.com/ec2/v2/connect/${{ secrets.EC2_INSTANCE_ID }}"
            echo ""
            echo "Step 2: Run these commands based on your OS:"
            echo ""
            echo "--- For Ubuntu (most common) ---"
            echo "sudo snap install amazon-ssm-agent --classic"
            echo "sudo snap start amazon-ssm-agent"
            echo "sudo snap services amazon-ssm-agent"
            echo ""
            echo "--- For Amazon Linux 2023 ---"
            echo "sudo yum install -y amazon-ssm-agent"
            echo "sudo systemctl enable amazon-ssm-agent"
            echo "sudo systemctl start amazon-ssm-agent"
            echo "sudo systemctl status amazon-ssm-agent"
            echo ""
            echo "--- For Amazon Linux 2 ---"
            echo "sudo systemctl enable amazon-ssm-agent"
            echo "sudo systemctl start amazon-ssm-agent"
            echo "sudo systemctl status amazon-ssm-agent"
            echo ""
            echo "Step 3: Verify SSM Agent is running"
            echo "   Should show 'active (running)' or 'active'"
            echo ""
            echo "Step 4: Wait 2-3 minutes for registration"
            echo ""
            echo "Step 5: Run this diagnostic workflow again"
            echo "   https://github.com/${{ github.repository }}/actions/workflows/diagnose-ssm.yml"
            echo ""
            echo "=========================================="
            exit 1
          fi

      - name: Test SSM Command
        run: |
          echo ""
          echo "=== Testing SSM Command ==="

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "SSM connectivity test" \
            --parameters 'commands=["echo \"SSM is working!\"","uname -a","which docker","docker --version || echo \"Docker not installed\""]' \
            --query "Command.CommandId" \
            --output text)

          echo "Command ID: $COMMAND_ID"
          echo "Waiting for result..."
          sleep 5

          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --query '[Status,StandardOutputContent]' \
            --output text

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "=========================================="
          echo "✅ SSM DIAGNOSTIC PASSED"
          echo "=========================================="
          echo ""
          echo "Your EC2 instance is ready for deployment!"
          echo "Go to Actions and run 'Deploy to EC2' workflow."
          echo ""
