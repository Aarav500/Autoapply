name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js application
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
        run: npm run build

      - name: Create deployment package
        run: |
          mkdir -p deploy

          # Copy standalone output
          cp -r .next/standalone/* deploy/

          # Copy static files (create .next directory structure first)
          mkdir -p deploy/.next
          cp -r .next/static deploy/.next/static

          # Copy public files
          cp -r public deploy/public

          # Copy Dockerfile
          cp Dockerfile.fast deploy/Dockerfile

          # Copy docker-compose.yml if it exists
          cp docker-compose.yml deploy/ || true

          # Create .env file
          cat > deploy/.env << EOF
          NODE_ENV=production
          AWS_REGION=${{ env.AWS_REGION }}
          AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_PHONE_NUMBER=${{ secrets.TWILIO_PHONE_NUMBER }}
          TWILIO_WHATSAPP_NUMBER=${{ secrets.TWILIO_WHATSAPP_NUMBER }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
          NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }}
          EOF

          tar -czf deploy.tar.gz -C deploy .

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload to S3
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          S3_PATH="s3://${{ secrets.S3_BUCKET_NAME }}/deployments/${TIMESTAMP}/deploy.tar.gz"
          aws s3 cp deploy.tar.gz "$S3_PATH"
          echo "S3_PATH=$S3_PATH" >> $GITHUB_ENV

      - name: Get EC2 IP address
        id: get-ip
        run: |
          EC2_IP=$(aws ec2 describe-instances \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "ec2_ip=$EC2_IP" >> $GITHUB_OUTPUT
          echo "EC2 IP: $EC2_IP"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.get-ip.outputs.ec2_ip }}
          username: ubuntu
          key: ${{ secrets.SECRET_KEY }}
          command_timeout: 20m
          script: |
            set -e

            echo "=== Starting deployment ==="

            # Stop existing containers
            echo "Stopping existing containers..."
            cd /home/ubuntu/autoapply || true
            docker-compose down || docker stop autoapply-app || true
            docker rm autoapply-app || true

            # Download from S3
            echo "Downloading deployment package..."
            mkdir -p /home/ubuntu/autoapply
            cd /home/ubuntu/autoapply
            aws s3 cp ${{ env.S3_PATH }} deploy.tar.gz

            # Extract
            echo "Extracting package..."
            rm -rf app
            mkdir -p app
            tar -xzf deploy.tar.gz -C app
            cd app

            # Build Docker image
            echo "Building Docker image..."
            docker build -f Dockerfile -t autoapply:latest .

            # Run container
            echo "Starting container..."
            docker run -d \
              --name autoapply-app \
              --restart unless-stopped \
              -p 3000:3000 \
              --env-file .env \
              autoapply:latest

            # Wait for health check
            echo "Waiting for application to start..."
            for i in {1..30}; do
              if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
                echo "✅ Application is healthy"
                docker logs autoapply-app --tail 20
                exit 0
              fi
              echo "Attempt $i/30: waiting..."
              sleep 2
            done

            echo "❌ Application failed to start"
            docker logs autoapply-app
            exit 1

      - name: Deployment summary
        if: always()
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Instance**: ${{ secrets.EC2_INSTANCE_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **IP**: ${{ steps.get-ip.outputs.ec2_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Package**: ${{ env.S3_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ **Application URL**: http://${{ steps.get-ip.outputs.ec2_ip }}:3000" >> $GITHUB_STEP_SUMMARY
          fi
